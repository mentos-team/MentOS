name: Ubuntu

# Trigger the workflow on push or pull requests for main and develop branches
on:
  push:
    branches:
    - main
    - develop
    paths:
    - '**/*.c'
    - '**/*.cpp'
    - '**/*.h'
    - '**/*.hpp'
    - '**/CMakeLists.txt'
    - '**/Makefile'
    - '**/cmake/**'
    - '.github/workflows/ubuntu.yml'
  pull_request:
    branches:
    - main
    - develop
    paths:
    - '**/*.c'
    - '**/*.cpp'
    - '**/*.h'
    - '**/*.hpp'
    - '**/CMakeLists.txt'
    - '**/Makefile'
    - '**/cmake/**'
    - '.github/workflows/ubuntu.yml'

jobs:
  build:
    name: Build and Compile
    strategy:
      fail-fast: false
      matrix:
        include:
          [
            # GCC - recent stable versions
            { pkgs: "nasm gcc-12 g++-12", cc: gcc-12, cxx: g++-12, os: ubuntu-latest },
            { pkgs: "nasm gcc-13 g++-13", cc: gcc-13, cxx: g++-13, os: ubuntu-latest },
            { pkgs: "nasm gcc-14 g++-14", cc: gcc-14, cxx: g++-14, os: ubuntu-latest },
            # Clang - recent stable versions
            { pkgs: "nasm clang-17 clang++-17", cc: clang-17, cxx: clang++-17, os: ubuntu-latest },
            { pkgs: "nasm clang-18 clang++-18", cc: clang-18, cxx: clang++-18, os: ubuntu-latest },
            { pkgs: "nasm clang-19 clang++-19", cc: clang-19, cxx: clang++-19, os: ubuntu-latest }
          ]
    runs-on: ${{ matrix.os }}
    # Set environment variables
    env:
      # We globally set CC and CXX.
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    steps:
    - name: Clone repository
      uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.pkgs }}
    - name: Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --parallel $(nproc)

  test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Clone repository
      uses: actions/checkout@v4

    - name: Install test dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc-9 g++-9 qemu-system-x86 mtools xorriso e2fsprogs

    - name: Build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DEMULATOR_OUTPUT_TYPE=OUTPUT_LOG
        cmake --build build --parallel $(nproc) --target filesystem
        ls -lh build/rootfs.img
        debugfs -R "stat /" build/rootfs.img
        debugfs -R "ls /bin" build/rootfs.img

    - name: Run tests
      run: |
        cmake --build build --parallel $(nproc) --target cdrom_test.iso
        ./scripts/run-qemu-test build 600
      timeout-minutes: 12

    - name: Check test results
      if: always()
      run: |
        echo "=== Test Output ==="
        cat build/test.log || echo "test.log not found"
        echo ""
        echo "=== TAP Results ==="
        cat build/test.log | scripts/tapview || echo "tapview failed"

    - name: Show serial log
      if: always()
      run: |
        echo "=== Serial Output ==="
        cat build/serial.log || echo "serial.log not found"

    - name: Archive the logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs
        path: |
          build/test.log
          build/serial.log
